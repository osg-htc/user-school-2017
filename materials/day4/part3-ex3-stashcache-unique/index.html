<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/user-school-2017/materials/day4/part3-ex3-stashcache-unique/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>3.3. StashCache â…¡ - OSG User School 2017</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Thursday Exercise 3.3: Using Stash for unique large input", url: "#_top", children: [
              {title: "Data", url: "#data" },
              {title: "Software", url: "#software" },
              {title: "Script", url: "#script" },
              {title: "Submit File", url: "#submit-file" },
              {title: "Initial Job", url: "#initial-job" },
              {title: "Multiple jobs", url: "#multiple-jobs" },
              {title: "Bonus", url: "#bonus" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="thursday-exercise-33-using-stash-for-unique-large-input">Thursday Exercise 3.3: Using Stash for unique large input<a class="headerlink" href="#thursday-exercise-33-using-stash-for-unique-large-input" title="Permanent link">&para;</a></h1>
<p>In this exercise, we will run a multimedia program that converts and manipulates video files. In particular, we want to convert large \ <code>.mov</code> files to smaller (10-100s of MB) <code>mp4</code> files. \ Just like the Blast database in the <a href="../part3-ex2-stashcache-shared/">previous exercise</a>, these video files are too large to send to jobs using HTCondor's default \ file transfer mechanism, so we'll be using the Stash tool to send our data to jobs. This exercise should take 25-30 minutes.</p>
<h2 id="data">Data<a class="headerlink" href="#data" title="Permanent link">&para;</a></h2>
<p>We'll start by moving our source movie files into Stash, so that they'll be available to our jobs when they run out on OSG.</p>
<ol>
<li>Log into <code>user-training.osgconnect.net</code> and move into the <code>public</code> directory.</li>
<li>The video files are currently stored on the squid proxy from the first exercise this afternoon. To place them in Stash, download them \</li>
</ol>
<p>using <code>wget</code>: \</p>
<div class="codehilite"><pre><span></span><code><span class="gp">%</span>UCL_PROMPT_SHORT% &lt;strong&gt;wget http://proxy.chtc.wisc.edu/osgschool17/videos.tar.gz&lt;/strong&gt;
</code></pre></div>

<p>\</p>
<ol>
<li>Once downloaded, untar the <code>tar.gz</code> file. It should contain three <code>.mov</code> files. (this may take a while since everyone else is likely doing the same thing)</li>
<li>How big are the three files? Which is the smallest? (Find out with <code>ls -lh</code>.)</li>
<li>We're going to need a list of these files later. For now, let's save that list to a file in this directory by running <code>ls</code> and redirecting the output to a file: \</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="gp">%</span>UCL_PROMPT_SHORT% &lt;strong&gt;ls *.MOV *.mov &gt; movie_list.txt&lt;/strong&gt;
</code></pre></div>

<ol>
<li>Once you've examined the three <code>mov</code> files and created the list of files, remove the original <code>tar.gz</code> file.</li>
</ol>
<h2 id="software">Software<a class="headerlink" href="#software" title="Permanent link">&para;</a></h2>
<p>We'll be using a multi-purpose media tool called <code>ffmpeg</code> \ to convert video formats. The basic command to convert a file looks like this: \</p>
<div class="codehilite"><pre><span></span><code><span class="gp">%</span>UCL_PROMPT_SHORT% &lt;strong&gt;./ffmpeg -i input.mov output.mp4&lt;/strong&gt;
</code></pre></div>

<p>In order to resize our files, we're going to manually set the video bitrate and resize the frames, so that the resulting file is smaller.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">%</span>UCL_PROMPT_SHORT% &lt;strong&gt;./ffmpeg -i input.mp4 -b:v 400k -s 640x360 output.mp4&lt;/strong&gt;
</code></pre></div>

<p>To get the <code>ffmpeg</code> program do the following:</p>
<ol>
<li><strong>On user-training.osgconnect.net</strong>, create a directory for this exercise and move into it.</li>
<li>We'll be downloading the <code>ffmpeg</code> pre-built static binary from this page: <a href="http://johnvansickle.com/ffmpeg/">http://johnvansickle.com/ffmpeg/</a>. \</li>
</ol>
<p>Look for the <code>x86_64</code> build. \</p>
<div class="codehilite"><pre><span></span><code><span class="gp">%</span>UCL_PROMPT_SHORT% &lt;strong&gt;wget http://johnvansickle.com/ffmpeg/releases/ffmpeg-release-64bit-static.tar.xz&lt;/strong&gt;
</code></pre></div>

<ol>
<li>Once the binary is downloaded, un-tar it, and then copy the main <code>ffmpeg</code> program into your current directory: \</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="gp">%</span>UCL_PROMPT_SHORT% &lt;strong&gt;tar -xf ffmpeg-release-64bit-static.tar.xz&lt;/strong&gt;
<span class="gp">%</span>UCL_PROMPT_SHORT% &lt;strong&gt;cp ffmpeg-3.3.2-64bit-static/ffmpeg ./&lt;/strong&gt;
</code></pre></div>

<h2 id="script">Script<a class="headerlink" href="#script" title="Permanent link">&para;</a></h2>
<p>We want to write a script that uses <code>ffmpeg</code> to convert a <code>.mov</code> file to a smaller format. Our script will need to <em>copy</em> \ that movie file from Stash to the job's current working directory (as in the <a href="../part3-ex2-stashcache-shared/">previous exercise</a>, <em>run</em> the appropriate <code>ffmpeg</code> command, \ and then <em>remove</em> the original movie file so that it doesn't get transferred back to the submit server. This last step is \ particularly important, as otherwise you will have large files transferring into the submit server and filling up your home directory space.</p>
<ol>
<li>Create a file called <code>run_ffmpeg.sh</code>, that does the steps described above. Use the name of the smallest <code>.mov</code> file \</li>
</ol>
<p>in the <code>ffmpeg</code> command. Once you've written your script, check it against the example below: \</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

module load stashcp
stashcp /user/%RED%username%ENDCOLOR%/public/test_open_terminal.mov ./
./ffmpeg -i test_open_terminal.mov -b:v 400k -s 640x360 test_open_terminal.mp4
rm test_open_terminal.mov
</code></pre></div>

<p>\ In your script, the username should be replaced by your <code>osg-connect</code> username.</p>
<p>Ultimately we'll want to submit several jobs (one for each <code>.mov</code> file), but to start with, we'll run one job to \ make sure that everything works.</p>
<h2 id="submit-file">Submit File<a class="headerlink" href="#submit-file" title="Permanent link">&para;</a></h2>
<p>Create a submit file for this job, based on other submit files from the school (<a href="UserSchool17Thurs22HTCondorFT#Start_with_a_test_submit_file">This file, for example</a>.) Things to consider:</p>
<ol>
<li>We'll be copying the video file into the job's working directory, so make sure to request enough disk space for the input <code>mov</code> file and the output <code>mp4</code> file. \</li>
</ol>
<p>If you're aren't sure how much to request, ask a helper in the room.</p>
<ol>
<li>*Important* Don't list the name of the <code>.mov</code> in <code>transfer_input_files</code>. Our job will be interacting with the input \</li>
</ol>
<p><code>.mov</code> files solely from within the script we wrote above.</p>
<ol>
<li>Note that we <strong>do</strong> need to transfer the <code>ffmpeg</code> program that we downloaded above. \</li>
</ol>
<div class="codehilite"><pre><span></span><code>transfer_input_files = ffmpeg
</code></pre></div>

<ol>
<li>Add the same requirements as the previous exercise: \</li>
</ol>
<div class="codehilite"><pre><span></span><code>+WantsStashCache = true
requirements = (OpSys == &quot;LINUX&quot;) &amp;&amp; (HAS_MODULES =?= true)
</code></pre></div>

<h2 id="initial-job">Initial Job<a class="headerlink" href="#initial-job" title="Permanent link">&para;</a></h2>
<p>With everything in place, submit the job. Once it finishes, we should check to make sure everything ran as expected:</p>
<ol>
<li>Check the directory where you submitted the job. Did the output <code>.mp4</code> file return?</li>
<li>Also in the directory where you submitted the job - did the original <code>.mov</code> file return here accidentally?</li>
<li>Check file sizes. How big is the returned <code>.mp4</code> file? How does that compare to the original <code>.mov</code> input?</li>
</ol>
<p>If your job successfully returned the converted <code>.mp4</code> file and <strong>not</strong> the <code>.mov</code> file to the submit server, and the <code>.mp4</code> file was appropriately scaled down, then we can go ahead and convert all of the files we uploaded to Stash.</p>
<h2 id="multiple-jobs">Multiple jobs<a class="headerlink" href="#multiple-jobs" title="Permanent link">&para;</a></h2>
<p>We wrote the name of the <code>.mov</code> file into our <code>run_ffmpeg.sh</code> executable script. To submit a set of jobs for all of our <code>.mov</code> \ files, what will we need to change in:</p>
<ol>
<li>the script? 2. the submit file?</li>
</ol>
<p>Once you've thought about it, check your reasoning against \ the instructions below.</p>
<h3 id="add-an-argument-to-your-script">Add an argument to your script<a class="headerlink" href="#add-an-argument-to-your-script" title="Permanent link">&para;</a></h3>
<ol>
<li>Look at your <code>run_ffmpeg.sh</code> script. What values will change for every job?</li>
<li>The input file will change with every job - and don't forget that the output file will too! Let's make them both into arguments. \</li>
</ol>
<p>To add arguments to a bash script, we use the notation <code>$1</code> for the first argument (our input file) and <code>$2</code> for the second argument (our output file name). \ The final script should look like this: \</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

module load stashcp
stashcp /user/%RED%username%ENDCOLOR%/public/<span class="nv">$1</span> ./
./ffmpeg -i <span class="nv">$1</span> -b:v 400k -s 640x360 <span class="nv">$2</span>
rm <span class="nv">$1</span>
</code></pre></div>

<p>\ Note that we use the input file name multiple times in our script, so we'll have to use <code>$1</code> multiple times as well.</p>
<h3 id="modify-your-submit-file">Modify your submit file<a class="headerlink" href="#modify-your-submit-file" title="Permanent link">&para;</a></h3>
<ol>
<li>We now need to tell each job what arguments to use. We will do this by adding an arguments line to our submit file. Because we'll only have \</li>
</ol>
<p>the input file name, the "output" file name will be the input file name with the <code>mp4</code> extension. That should look like this: \</p>
<div class="codehilite"><pre><span></span><code>arguments = $(mov) $(mov).mp4
</code></pre></div>

<ol>
<li>To set these arguments, we will use the <code>queue .. matching</code> syntax that we learned on <a href="../../day1/part2-ex6-queue-from/">Monday</a>. To \ do so, we need to create a list of our input files. 3. In our submit file, we can then change our queue statement to: \</li>
</ol>
<div class="codehilite"><pre><span></span><code>queue mov from movie_list.txt
</code></pre></div>

<p>Once you've made these changes, try submitting all the jobs!</p>
<h2 id="bonus">Bonus<a class="headerlink" href="#bonus" title="Permanent link">&para;</a></h2>
<p>If you wanted to set a different output file name, bitrate and/or size for each original movie, how could you modify:</p>
<ol>
<li><code>movie_list.txt</code> 3. Your submit file 2. <code>run_ffmpeg.sh</code></li>
</ol>
<p>to do so?</p>
<details>
  <summary>Show hint</summary> Here's the changes you can make to the various files:

1.  `movie_list.txt` \\


<div class="codehilite"><pre><span></span><code>ducks.MOV ducks.mp4 500k 1280x720
teaching.MOV teaching.mp4 400k 320x180
test_open_terminal.mov terminal.mp4 600k 640x360
</code></pre></div>



2. Submit file\\


<div class="codehilite"><pre><span></span><code>arguments = $(mov) $(mp4) $(bitrate) $(size)

queue mov,mp4,bitrate,size from movie_list.txt
</code></pre></div>



3. `run_ffmpeg.sh` \\


<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

module load stashcp
stashcp /user/%RED%username%ENDCOLOR%/public/<span class="nv">$1</span> ./
./ffmpeg -i <span class="nv">$1</span> -b:v <span class="nv">$3</span> -s <span class="nv">$4</span> <span class="nv">$2</span>
rm <span class="nv">$1</span>
</code></pre></div>



</details>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part4-ex1-input/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part4-ex1-input/" class="btn btn-xs btn-link">
        4.1. Shared FS input
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part3-ex2-stashcache-shared/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part3-ex2-stashcache-shared/" class="btn btn-xs btn-link">
        3.2. StashCache â… 
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>