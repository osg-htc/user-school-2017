<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/user-school-2017/materials/day1/part3-ex4-complex-dag/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>3.4. More complex DAG - OSG User School 2017</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Monday Exercise 3.4: A More Complex DAG", url: "#_top", children: [
              {title: "Make Your Job Submission Files", url: "#make-your-job-submission-files" },
              {title: "Make your DAG", url: "#make-your-dag" },
              {title: "Running the DAG", url: "#running-the-dag" },
              {title: "Watch Your DAG", url: "#watch-your-dag" },
              {title: "On Your Own", url: "#on-your-own" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <p>a<style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: #008; } </style></p>
<h1 id="monday-exercise-34-a-more-complex-dag">Monday Exercise 3.4: A More Complex DAG<a class="headerlink" href="#monday-exercise-34-a-more-complex-dag" title="Permanent link">&para;</a></h1>
<p>The objective of this exercise is to run a real set of jobs with DAGMan.</p>
<h2 id="make-your-job-submission-files">Make Your Job Submission Files<a class="headerlink" href="#make-your-job-submission-files" title="Permanent link">&para;</a></h2>
<p>We'll run our <code>goatbrot</code> example. If you didn't read about it yet, <a href="UserSchool16Mon32Mandelbrot">please do so now</a>. We are going to make a DAG with four simultaneous jobs (<code>goatbrot</code>) and one final node to stitch them together (<code>montage</code>). This means we have five jobs. We're going to run <code>goatbrot</code> with more iterations (100,000) so each job will take longer to run.</p>
<p>You can create your five jobs. The goatbrot jobs are very similar to each other, but they have slightly different parameters and output files.</p>
<h3 id="goatbrot1sub">goatbrot1.sub<a class="headerlink" href="#goatbrot1sub" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-file">executable              = /usr/local/bin/goatbrot
arguments               = -i 100000 -c -0.75,0.75 -w 1.5 -s 500,500 -o tile_0_0.ppm
log                     = goatbrot.log
output                  = goatbrot.out.0.0
error                   = goatbrot.err.0.0
request_memory = 1GB
request_disk       = 1GB
request_cpus      = 1
queue
</code></pre>

<h3 id="goatbrot2sub">goatbrot2.sub<a class="headerlink" href="#goatbrot2sub" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-file">executable              = /usr/local/bin/goatbrot
arguments               = -i 100000 -c 0.75,0.75 -w 1.5 -s 500,500 -o tile_0_1.ppm
log                     = goatbrot.log
output                  = goatbrot.out.0.1
error                   = goatbrot.err.0.1
request_memory = 1GB
request_disk       = 1GB
request_cpus      = 1
queue
</code></pre>

<h3 id="goatbrot3sub">goatbrot3.sub<a class="headerlink" href="#goatbrot3sub" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-file">executable              = /usr/local/bin/goatbrot
arguments               = -i 100000 -c -0.75,-0.75 -w 1.5 -s 500,500 -o tile_1_0.ppm
log                     = goatbrot.log
output                  = goatbrot.out.1.0
error                   = goatbrot.err.1.0
request_memory = 1GB
request_disk       = 1GB
request_cpus      = 1
queue
</code></pre>

<h3 id="goatbrot4sub">goatbrot4.sub<a class="headerlink" href="#goatbrot4sub" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-file">executable              = /usr/local/bin/goatbrot
arguments               = -i 100000 -c 0.75,-0.75 -w 1.5 -s 500,500 -o tile_1_1.ppm
log                     = goatbrot.log
output                  = goatbrot.out.1.1
error                   = goatbrot.err.1.1
request_memory = 1GB
request_disk       = 1GB
request_cpus      = 1
queue
</code></pre>

<h3 id="montagesub">montage.sub<a class="headerlink" href="#montagesub" title="Permanent link">&para;</a></h3>
<p>You should notice that the <code>transfer_input_files</code> statement refers to the files created by the other jobs.</p>
<pre class="codehilite"><code class="language-file">executable              = /usr/bin/montage
arguments               = tile_0_0.ppm tile_0_1.ppm tile_1_0.ppm tile_1_1.ppm -mode Concatenate -tile 2x2 mandel-from-dag.jpg
transfer_input_files    = tile_0_0.ppm,tile_0_1.ppm,tile_1_0.ppm,tile_1_1.ppm
output                  = montage.out
error                   = montage.err
log                     = montage.log
request_memory = 1GB
request_disk       = 1GB
request_cpus      = 1
queue
</code></pre>

<h2 id="make-your-dag">Make your DAG<a class="headerlink" href="#make-your-dag" title="Permanent link">&para;</a></h2>
<p>In a file called <code>goatbrot.dag</code>, you have your DAG specification:</p>
<pre class="codehilite"><code class="language-file">JOB g1 goatbrot1.sub
JOB g2 goatbrot2.sub
JOB g3 goatbrot3.sub
JOB g4 goatbrot4.sub
JOB montage montage.sub
PARENT g1 g2 g3 g4 CHILD montage
</code></pre>

<p>Ask yourself: do you know how we ensure that all the <code>goatbrot</code> commands can run simultaneously and all of them will complete before we run the montage job?</p>
<h2 id="running-the-dag">Running the DAG<a class="headerlink" href="#running-the-dag" title="Permanent link">&para;</a></h2>
<p>Submit your DAG:</p>
<pre class="codehilite"><code class="language-console">%UCL_PROMPT_SHORT% &lt;strong&gt;condor_submit_dag goatbrot.dag&lt;/strong&gt;
-----------------------------------------------------------------------
File for submitting this DAG to Condor           : goatbrot.dag.condor.sub
Log of DAGMan debugging messages                 : goatbrot.dag.dagman.out
Log of Condor library output                     : goatbrot.dag.lib.out
Log of Condor library error messages             : goatbrot.dag.lib.err
Log of the life of condor_dagman itself          : goatbrot.dag.dagman.log

Submitting job(s).
1 job(s) submitted to cluster 71.

-----------------------------------------------------------------------
</code></pre>

<h2 id="watch-your-dag">Watch Your DAG<a class="headerlink" href="#watch-your-dag" title="Permanent link">&para;</a></h2>
<p>Letâ€™s follow the progress of the whole DAG:</p>
<ol>
<li>Use the <code>watch</code> command to run <code>condor_q -nobatch</code> every 10 seconds: <pre class="screen"></li>
</ol>
<p><span class="twiki-macro UCL_PROMPT_SHORT"></span> <strong>watch -n 10 condor_q -nobatch</strong></p>
<p>%RED%Here we see DAGMan running:<span class="twiki-macro ENDCOLOR"></span> -- Submitter: learn.chtc.wisc.edu : &lt;128.104.100.55:9618?sock=28867_10e4_2&gt; : learn.chtc.wisc.edu ID OWNER SUBMITTED RUN_TIME ST PRI SIZE CMD 71.0 roy 6/22 17:39 0+00:00:03 R 0 0.3 condor_dagman</p>
<p>1 jobs; 0 completed, 0 removed, 0 idle, 1 running, 0 held, 0 suspended</p>
<p>%RED%DAGMan has submitted the goatbrot jobs, but they haven't started running yet:<span class="twiki-macro ENDCOLOR"></span> -- Submitter: learn.chtc.wisc.edu : &lt;128.104.100.55:9618?sock=28867_10e4_2&gt; : learn.chtc.wisc.edu ID OWNER SUBMITTED RUN_TIME ST PRI SIZE CMD 71.0 roy 6/22 17:39 0+00:00:17 R 0 0.3 condor_dagman 72.0 roy 6/22 17:39 0+00:00:00 I 0 0.0 goatbrot -i 100000 73.0 roy 6/22 17:39 0+00:00:00 I 0 0.0 goatbrot -i 100000 74.0 roy 6/22 17:39 0+00:00:00 I 0 0.0 goatbrot -i 100000 75.0 roy 6/22 17:39 0+00:00:00 I 0 0.0 goatbrot -i 100000</p>
<p>5 jobs; 0 completed, 0 removed, 4 idle, 1 running, 0 held, 0 suspended</p>
<p>%RED%They're running%ENDCOLOR% -- Submitter: learn.chtc.wisc.edu : &lt;128.104.100.55:9618?sock=28867_10e4_2&gt; : learn.chtc.wisc.edu ID OWNER SUBMITTED RUN_TIME ST PRI SIZE CMD 71.0 roy 6/22 17:39 0+00:07:15 R 0 0.3 condor_dagman 72.0 roy 6/22 17:39 0+00:00:03 R 0 0.0 goatbrot -i 100000 73.0 roy 6/22 17:39 0+00:00:03 R 0 0.0 goatbrot -i 100000 74.0 roy 6/22 17:39 0+00:00:03 R 0 0.0 goatbrot -i 100000 75.0 roy 6/22 17:39 0+00:00:03 R 0 0.0 goatbrot -i 100000</p>
<p>5 jobs; 0 completed, 0 removed, 0 idle, 5 running, 0 held, 0 suspended</p>
<p>%RED%Two of the jobs have finished, while the others are still running:<span class="twiki-macro ENDCOLOR"></span> -- Submitter: learn.chtc.wisc.edu : &lt;128.104.100.55:9618?sock=28867_10e4_2&gt; : learn.chtc.wisc.edu ID OWNER SUBMITTED RUN_TIME ST PRI SIZE CMD 71.0 roy 6/22 17:39 0+00:07:51 R 0 0.3 condor_dagman 72.0 roy 6/22 17:39 0+00:00:39 R 0 0.0 goatbrot -i 100000 74.0 roy 6/22 17:39 0+00:00:39 R 0 0.0 goatbrot -i 100000</p>
<p>3 jobs; 0 completed, 0 removed, 0 idle, 3 running, 0 held, 0 suspended</p>
<p>%RED%They finished, but DAGMan hasn't noticed yet. It only checks periodically:<span class="twiki-macro ENDCOLOR"></span> -- Submitter: learn.chtc.wisc.edu : &lt;128.104.100.55:9618?sock=28867_10e4_2&gt; : learn.chtc.wisc.edu ID OWNER SUBMITTED RUN_TIME ST PRI SIZE CMD 71.0 roy 6/22 17:39 0+00:08:46 R 0 0.3 condor_dagman</p>
<p>1 jobs; 0 completed, 0 removed, 0 idle, 1 running, 0 held, 0 suspended</p>
<p>%RED%DAGMan submitted and ran the montage job. It ran so fast I didn't capture it running. DAGMan will finish up soon <span class="twiki-macro ENDCOLOR"></span> -- Submitter: learn.chtc.wisc.edu : &lt;128.104.100.55:9618?sock=28867_10e4_2&gt; : learn.chtc.wisc.edu ID OWNER SUBMITTED RUN_TIME ST PRI SIZE CMD 71.0 roy 6/22 17:39 0+00:08:55 R 0 0.3 condor_dagman</p>
<p>1 jobs; 0 completed, 0 removed, 0 idle, 1 running, 0 held, 0 suspended</p>
<p>%RED%Now it's all done:<span class="twiki-macro ENDCOLOR"></span> -- Submitter: learn.chtc.wisc.edu : &lt;128.104.100.55:9618?sock=28867_10e4_2&gt; : learn.chtc.wisc.edu ID OWNER SUBMITTED RUN_TIME ST PRI SIZE CMD</p>
<p>0 jobs; 0 completed, 0 removed, 0 idle, 0 running, 0 held, 0 suspended </pre></p>
<ol>
<li>Examine your results. For some reason, goatbrot prints everything to stderr, not stdout. <pre class="screen"></li>
</ol>
<p><span class="twiki-macro UCL_PROMPT_SHORT"></span> <strong>cat goatbrot.err.0.0</strong> Complex image: Center: -0.75 + 0.75i Width: 1.5 Height: 1.5 Upper Left: -1.5 + 1.5i Lower Right: 0 + 0i</p>
<p>Output image: Filename: tile_0_0.ppm Width, Height: 500, 500 Theme: beej Antialiased: no</p>
<p>Mandelbrot: Max Iterations: 100000 Continuous: no</p>
<p>Goatbrot: Multithreading: not supported in this build</p>
<p>Completed: 100.0% </pre></p>
<ol>
<li><p>Examine your log files (<code>goatbrot.log</code> and <code>montage.log</code>) and DAGMan output file (<code>goatbrot.dag.dagman.out</code>). Do they look as you expect? Can you see the progress of the DAG in the DAGMan output file?</p></li>
<li><p>As you did earlier, copy the resulting <code>mandel-from-dag.jpg</code> to your <code>public_html</code> directory, then access it from your web browser. Does the image look correct?</p></li>
<li><p>Clean up your results. Be careful about deleting the <code>goatbrot.dag.*</code> files, you do not want to delete the <code>goatbrot.dag</code> file, just <code>goatbrot.dag.*</code>.</p> <pre class="screen"></li>
</ol>
<p><span class="twiki-macro UCL_PROMPT_SHORT"></span> <strong>rm goatbrot.dag.*</strong> <span class="twiki-macro UCL_PROMPT_SHORT"></span> <strong>rm goatbrot.out.*</strong> <span class="twiki-macro UCL_PROMPT_SHORT"></span> <strong>rm goatbrot.err.*</strong> </pre></p>
<h2 id="on-your-own">On Your Own<a class="headerlink" href="#on-your-own" title="Permanent link">&para;</a></h2>
<ul>
<li>Re-run your DAG. When jobs are running, try <code>condor_q -nobatch -dag</code>. What does it do differently?</li>
<li>Challenge, if you have time: Make a bigger DAG by making more tiles in the same area.</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part4-ex1-failed-dag/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part4-ex1-failed-dag/" class="btn btn-xs btn-link">
        4.1. Failed DAG jobs
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part3-ex3-simple-dag/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part3-ex3-simple-dag/" class="btn btn-xs btn-link">
        3.3. Simple DAG
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>